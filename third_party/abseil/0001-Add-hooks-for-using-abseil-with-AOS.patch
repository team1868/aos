From df5d29bd7a0aaecf80383c22ae2debb92e384adc Mon Sep 17 00:00:00 2001
From: Philipp Schrader <philipp.schrader@bluerivertech.com>
Date: Tue, 25 Mar 2025 06:44:36 -0700
Subject: [PATCH] Add hooks for using abseil with AOS
 
---
 absl/base/attributes.h                 |  2 +-
 absl/copts/GENERATED_AbseilCopts.cmake | 30 ++++++++++++++++++++++++--
 absl/copts/GENERATED_copts.bzl         | 30 ++++++++++++++++++++++++--
 absl/copts/configure_copts.bzl         |  9 ++------
 absl/copts/copts.py                    | 15 ++++++++++++-
 absl/log/internal/check_op.cc          | 12 +++++++++++
 absl/log/internal/log_message.cc       | 22 ++++++++++++++++---
 absl/random/internal/BUILD.bazel       |  1 +
 absl/strings/BUILD.bazel               |  1 +
 absl/time/internal/cctz/BUILD.bazel    |  9 ++++++++
 10 files changed, 115 insertions(+), 16 deletions(-)

diff --git a/absl/base/attributes.h b/absl/base/attributes.h
index d009f6d4..4bc7aae5 100644
--- a/absl/base/attributes.h
+++ b/absl/base/attributes.h
@@ -203,7 +203,7 @@
 // Deprecated: Prefer the `[[noreturn]]` attribute standardized by C++11 over
 // this macro.
 #if ABSL_HAVE_ATTRIBUTE(noreturn) || (defined(__GNUC__) && !defined(__clang__))
-#define ABSL_ATTRIBUTE_NORETURN __attribute__((noreturn))
+#define ABSL_ATTRIBUTE_NORETURN [[noreturn]]
 #elif defined(_MSC_VER)
 #define ABSL_ATTRIBUTE_NORETURN __declspec(noreturn)
 #else
diff --git a/absl/copts/GENERATED_AbseilCopts.cmake b/absl/copts/GENERATED_AbseilCopts.cmake
index 7d8af924..db9c5846 100644
--- a/absl/copts/GENERATED_AbseilCopts.cmake
+++ b/absl/copts/GENERATED_AbseilCopts.cmake
@@ -51,6 +51,13 @@ list(APPEND ABSL_GCC_FLAGS
     "-Wundef"
     "-Wunused-local-typedefs"
     "-Wunused-result"
+    "-Wno-format-nonliteral"
+    "-Wno-tautological-type-limit-compare"
+    "-Wno-unused-parameter"
+    "-Wno-sign-conversion"
+    "-Wno-shorten-64-to-32"
+    "-Wno-shadow"
+    "-Wno-stringop-overflow"
     "-Wvarargs"
     "-Wvla"
     "-Wwrite-strings"
@@ -69,6 +76,13 @@ list(APPEND ABSL_GCC_TEST_FLAGS
     "-Wundef"
     "-Wunused-local-typedefs"
     "-Wunused-result"
+    "-Wno-format-nonliteral"
+    "-Wno-tautological-type-limit-compare"
+    "-Wno-unused-parameter"
+    "-Wno-sign-conversion"
+    "-Wno-shorten-64-to-32"
+    "-Wno-shadow"
+    "-Wno-stringop-overflow"
     "-Wvarargs"
     "-Wvla"
     "-Wwrite-strings"
@@ -102,8 +116,8 @@ list(APPEND ABSL_LLVM_FLAGS
     "-Woverlength-strings"
     "-Wpointer-arith"
     "-Wself-assign"
-    "-Wshadow-all"
     "-Wshorten-64-to-32"
+    "-Wno-shadow"
     "-Wsign-conversion"
     "-Wstring-conversion"
     "-Wtautological-overlap-compare"
@@ -122,6 +136,12 @@ list(APPEND ABSL_LLVM_FLAGS
     "-Wno-implicit-int-float-conversion"
     "-Wno-unknown-warning-option"
     "-DNOMINMAX"
+    "-Wno-format-nonliteral"
+    "-Wno-unused-parameter"
+    "-Wno-tautological-type-limit-compare"
+    "-Wno-sign-conversion"
+    "-Wno-shorten-64-to-32"
+    "-Wno-stringop-overflow"
 )
 
 list(APPEND ABSL_LLVM_TEST_FLAGS
@@ -143,7 +163,7 @@ list(APPEND ABSL_LLVM_TEST_FLAGS
     "-Woverlength-strings"
     "-Wpointer-arith"
     "-Wself-assign"
-    "-Wshadow-all"
+    "-Wno-shadow"
     "-Wstring-conversion"
     "-Wtautological-overlap-compare"
     "-Wtautological-unsigned-zero-compare"
@@ -161,6 +181,12 @@ list(APPEND ABSL_LLVM_TEST_FLAGS
     "-Wno-implicit-int-float-conversion"
     "-Wno-unknown-warning-option"
     "-DNOMINMAX"
+    "-Wno-format-nonliteral"
+    "-Wno-unused-parameter"
+    "-Wno-tautological-type-limit-compare"
+    "-Wno-sign-conversion"
+    "-Wno-shorten-64-to-32"
+    "-Wno-stringop-overflow"
     "-Wno-deprecated-declarations"
     "-Wno-implicit-int-conversion"
     "-Wno-missing-prototypes"
diff --git a/absl/copts/GENERATED_copts.bzl b/absl/copts/GENERATED_copts.bzl
index 23896e9d..e49dbc6d 100644
--- a/absl/copts/GENERATED_copts.bzl
+++ b/absl/copts/GENERATED_copts.bzl
@@ -52,6 +52,13 @@ ABSL_GCC_FLAGS = [
     "-Wundef",
     "-Wunused-local-typedefs",
     "-Wunused-result",
+    "-Wno-format-nonliteral",
+    "-Wno-tautological-type-limit-compare",
+    "-Wno-unused-parameter",
+    "-Wno-sign-conversion",
+    "-Wno-shorten-64-to-32",
+    "-Wno-shadow",
+    "-Wno-stringop-overflow",
     "-Wvarargs",
     "-Wvla",
     "-Wwrite-strings",
@@ -70,6 +77,13 @@ ABSL_GCC_TEST_FLAGS = [
     "-Wundef",
     "-Wunused-local-typedefs",
     "-Wunused-result",
+    "-Wno-format-nonliteral",
+    "-Wno-tautological-type-limit-compare",
+    "-Wno-unused-parameter",
+    "-Wno-sign-conversion",
+    "-Wno-shorten-64-to-32",
+    "-Wno-shadow",
+    "-Wno-stringop-overflow",
     "-Wvarargs",
     "-Wvla",
     "-Wwrite-strings",
@@ -103,8 +117,8 @@ ABSL_LLVM_FLAGS = [
     "-Woverlength-strings",
     "-Wpointer-arith",
     "-Wself-assign",
-    "-Wshadow-all",
     "-Wshorten-64-to-32",
+    "-Wno-shadow",
     "-Wsign-conversion",
     "-Wstring-conversion",
     "-Wtautological-overlap-compare",
@@ -123,6 +137,12 @@ ABSL_LLVM_FLAGS = [
     "-Wno-implicit-int-float-conversion",
     "-Wno-unknown-warning-option",
     "-DNOMINMAX",
+    "-Wno-format-nonliteral",
+    "-Wno-unused-parameter",
+    "-Wno-tautological-type-limit-compare",
+    "-Wno-sign-conversion",
+    "-Wno-shorten-64-to-32",
+    "-Wno-stringop-overflow",
 ]
 
 ABSL_LLVM_TEST_FLAGS = [
@@ -144,7 +164,7 @@ ABSL_LLVM_TEST_FLAGS = [
     "-Woverlength-strings",
     "-Wpointer-arith",
     "-Wself-assign",
-    "-Wshadow-all",
+    "-Wno-shadow",
     "-Wstring-conversion",
     "-Wtautological-overlap-compare",
     "-Wtautological-unsigned-zero-compare",
@@ -162,6 +182,12 @@ ABSL_LLVM_TEST_FLAGS = [
     "-Wno-implicit-int-float-conversion",
     "-Wno-unknown-warning-option",
     "-DNOMINMAX",
+    "-Wno-format-nonliteral",
+    "-Wno-unused-parameter",
+    "-Wno-tautological-type-limit-compare",
+    "-Wno-sign-conversion",
+    "-Wno-shorten-64-to-32",
+    "-Wno-stringop-overflow",
     "-Wno-deprecated-declarations",
     "-Wno-implicit-int-conversion",
     "-Wno-missing-prototypes",
diff --git a/absl/copts/copts.py b/absl/copts/copts.py
index 8cf8f310..d356df71 100644
--- a/absl/copts/copts.py
+++ b/absl/copts/copts.py
@@ -24,6 +24,13 @@ ABSL_GCC_FLAGS = [
     "-Wundef",
     "-Wunused-local-typedefs",
     "-Wunused-result",
+    "-Wno-format-nonliteral",
+    "-Wno-tautological-type-limit-compare",
+    "-Wno-unused-parameter",
+    "-Wno-sign-conversion",
+    "-Wno-shorten-64-to-32",
+    "-Wno-shadow",
+    "-Wno-stringop-overflow",
     "-Wvarargs",
     "-Wvla",  # variable-length array
     "-Wwrite-strings",
@@ -61,8 +68,8 @@ ABSL_LLVM_FLAGS = [
     "-Woverlength-strings",
     "-Wpointer-arith",
     "-Wself-assign",
-    "-Wshadow-all",
     "-Wshorten-64-to-32",
+    "-Wno-shadow",
     "-Wsign-conversion",
     "-Wstring-conversion",
     "-Wtautological-overlap-compare",
@@ -86,6 +93,12 @@ ABSL_LLVM_FLAGS = [
     "-Wno-unknown-warning-option",
     # Don't define min and max macros (Build on Windows using clang)
     "-DNOMINMAX",
+    "-Wno-format-nonliteral",
+    "-Wno-unused-parameter",
+    "-Wno-tautological-type-limit-compare",
+    "-Wno-sign-conversion",
+    "-Wno-shorten-64-to-32",
+    "-Wno-stringop-overflow",
 ]
 
 ABSL_LLVM_TEST_ADDITIONAL_FLAGS = [
diff --git a/absl/log/internal/check_op.cc b/absl/log/internal/check_op.cc
index 23db63bf..63bbd85a 100644
--- a/absl/log/internal/check_op.cc
+++ b/absl/log/internal/check_op.cc
@@ -31,6 +31,17 @@
 #include <strings.h>  // for strcasecmp, but msvc does not have this header
 #endif
 
+namespace aos {
+void FatalUnsetRealtimePriority() __attribute__((weak));
+}
+
+static void MaybeUnsetRealtime() {
+  if (&aos::FatalUnsetRealtimePriority != nullptr) {
+    aos::FatalUnsetRealtimePriority();
+  }
+}
+
+
 namespace absl {
 ABSL_NAMESPACE_BEGIN
 namespace log_internal {
@@ -55,6 +66,7 @@ ABSL_LOG_INTERNAL_DEFINE_MAKE_CHECK_OP_STRING(const void*);
 
 CheckOpMessageBuilder::CheckOpMessageBuilder(
     const char* absl_nonnull exprtext) {
+  MaybeUnsetRealtime();
   stream_ << exprtext << " (";
 }
 
diff --git a/absl/log/internal/log_message.cc b/absl/log/internal/log_message.cc
index 3aed3a2f..5bb65e38 100644
--- a/absl/log/internal/log_message.cc
+++ b/absl/log/internal/log_message.cc
@@ -66,6 +66,16 @@ extern "C" ABSL_ATTRIBUTE_WEAK void ABSL_INTERNAL_C_SYMBOL(
   // Default - Do nothing
 }
 
+namespace aos {
+void FatalUnsetRealtimePriority() __attribute__((weak));
+}
+
+static void MaybeUnsetRealtime() {
+  if (&aos::FatalUnsetRealtimePriority != nullptr) {
+    aos::FatalUnsetRealtimePriority();
+  }
+}
+
 namespace absl {
 ABSL_NAMESPACE_BEGIN
 namespace log_internal {
@@ -267,7 +277,7 @@ void LogMessage::LogMessageData::FinalizeEncodingAndFormat() {
   }
   auto chars_written =
       static_cast<size_t>(string_remaining.data() - string_buf.data());
-    string_buf[chars_written++] = '\n';
+  string_buf[chars_written++] = '\n';
   string_buf[chars_written++] = '\0';
   entry.text_message_with_prefix_and_newline_and_nul_ =
       absl::MakeSpan(string_buf).subspan(0, chars_written);
@@ -275,8 +285,14 @@ void LogMessage::LogMessageData::FinalizeEncodingAndFormat() {
 
 LogMessage::LogMessage(const char* absl_nonnull file, int line,
                        absl::LogSeverity severity)
-    : data_(absl::make_unique<LogMessageData>(file, line, severity,
-                                              absl::Now())) {
+    : data_([&]() {
+        if (severity == absl::LogSeverity::kFatal &&
+            absl::log_internal::ExitOnDFatal()) {
+          MaybeUnsetRealtime();
+        }
+        return absl::make_unique<LogMessageData>(file, line, severity,
+                                                 absl::Now());
+      }()) {
   data_->first_fatal = false;
   data_->is_perror = false;
   data_->fail_quietly = false;
diff --git a/absl/random/internal/BUILD.bazel b/absl/random/internal/BUILD.bazel
index 994fb5c9..467f2ebf 100644
--- a/absl/random/internal/BUILD.bazel
+++ b/absl/random/internal/BUILD.bazel
@@ -755,6 +755,7 @@ cc_test(
 cc_library(
     name = "nanobenchmark",
     srcs = ["nanobenchmark.cc"],
+    copts = ABSL_DEFAULT_COPTS,
     linkopts = ABSL_DEFAULT_LINKOPTS,
     textual_hdrs = ["nanobenchmark.h"],
     deps = [
diff --git a/absl/strings/BUILD.bazel b/absl/strings/BUILD.bazel
index bb152acc..1ed56886 100644
--- a/absl/strings/BUILD.bazel
+++ b/absl/strings/BUILD.bazel
@@ -798,6 +798,7 @@ cc_test(
     srcs = [
         "internal/cordz_info_statistics_test.cc",
     ],
+    copts = ABSL_DEFAULT_COPTS,
     deps = [
         ":cord",
         ":cord_internal",
diff --git a/absl/time/internal/cctz/BUILD.bazel b/absl/time/internal/cctz/BUILD.bazel
index da30a0f1..b184116a 100644
--- a/absl/time/internal/cctz/BUILD.bazel
+++ b/absl/time/internal/cctz/BUILD.bazel
@@ -22,6 +22,13 @@ package(features = [
 
 licenses(["notice"])
 
+load(
+    "//absl:copts/configure_copts.bzl",
+    "ABSL_DEFAULT_COPTS",
+    "ABSL_DEFAULT_LINKOPTS",
+    "ABSL_TEST_COPTS",
+)
+
 ### libraries
 
 cc_library(
