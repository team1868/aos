diff --git a/BUILD b/BUILD
index 451b695..bc46654 100644
--- a/BUILD
+++ b/BUILD
@@ -46,7 +46,8 @@
     ]],
     copts = [
         "-Wno-sign-compare",
-        "-DCERES_TEST_SRCDIR_SUFFIX=\\\"_main/data/\\\"",
+        "-Wno-unused-but-set-variable",
+        "-DCERES_TEST_SRCDIR_SUFFIX=\\\"ceres-solver+/data/\\\"",
     ],
     includes = [
         "internal",
@@ -157,6 +158,12 @@
     timeout = "short",
     srcs = ["internal/ceres/" + test_name + "_test.cc"],
     deps = TEST_DEPS,
+    copts = [
+        "-Wno-unused-parameter",
+        "-Wno-use-after-free",
+        "-Wno-unknown-warning-option",
+    ],
+    data = [":data/problem-16-22106-pre.txt"],
 ) for test_name in CERES_TESTS]
 
 # Instantiate all the bundle adjustment tests. These are separate to
@@ -180,7 +187,15 @@
 [cc_binary(
     name = benchmark_name,
     srcs = ["internal/ceres/" + benchmark_name + ".cc"],
-    copts = ["-mllvm -inlinehint-threshold=1000000"],
+    copts = select({
+        "@rules_cc//cc/compiler:clang": ["-mllvm -inlinehint-threshold=1000000"],
+        "@rules_cc//cc/compiler:gcc": [
+            "-finline-limit=1000000",
+            "--param=inline-unit-growth=1000000",
+            "--param=large-function-growth=1000000",
+        ],
+        "//conditions:default": [],
+    }),
     deps = TEST_DEPS + ["@google_benchmark//:benchmark"],
 
 ) for benchmark_name in [
diff --git a/bazel/ceres.bzl b/bazel/ceres.bzl
index ed4d66d..be8948d 100644
--- a/bazel/ceres.bzl
+++ b/bazel/ceres.bzl
@@ -34,6 +34,7 @@
     "dogleg_strategy.cc",
     "dynamic_compressed_row_jacobian_writer.cc",
     "dynamic_compressed_row_sparse_matrix.cc",
+    "dynamic_cost_function_to_functor.cc",
     "dynamic_sparse_normal_cholesky_solver.cc",
     "eigensparse.cc",
     "evaluation_callback.cc",
diff --git a/internal/ceres/autodiff_test.cc b/internal/ceres/autodiff_test.cc
index b50327cb..19adcae0 100644
--- a/internal/ceres/autodiff_test.cc
+++ b/internal/ceres/autodiff_test.cc
@@ -647,6 +647,10 @@ TEST(AutoDiff, VariadicAutoDiff) {
   }
 }
 
+#ifdef __clang__
+#pragma clang diagnostic push
+#pragma clang diagnostic ignored "-Wunused-but-set-variable"
+#endif
 // This is fragile test that triggers the alignment bug on
 // i686-apple-darwin10-llvm-g++-4.2 (GCC) 4.2.1. It is quite possible,
 // that other combinations of operating system + compiler will
@@ -671,5 +675,8 @@ TEST(AutoDiff, AlignedAllocationTest) {
   // Need this to makes sure that x does not get optimized out.
   x[0] = x[0] + JetT(1.0);
 }
+#ifdef __clang__
+#pragma clang diagnostic pop
+#endif
 
 }  // namespace ceres::internal
diff --git a/internal/ceres/triplet_sparse_matrix_test.cc b/internal/ceres/triplet_sparse_matrix_test.cc
index e145c1a2..bde9a6ed 100644
--- a/internal/ceres/triplet_sparse_matrix_test.cc
+++ b/internal/ceres/triplet_sparse_matrix_test.cc
@@ -184,8 +184,15 @@ TEST(TripletSparseMatrix, AssignmentOperatorSelfAssignment) {
   orig.mutable_values()[1] = 5.2;
   orig.set_num_nonzeros(2);
 
+#ifdef __clang__
+#pragma clang diagnostic push
+#pragma clang diagnostic ignored "-Wself-assign-overloaded"
+#endif
   // Who's on earth gonna do this?
   orig = orig;
+#ifdef __clang__
+#pragma clang diagnostic pop
+#endif
 
   EXPECT_EQ(orig.num_rows(), 2);
   EXPECT_EQ(orig.num_cols(), 5);
diff --git a/internal/ceres/triplet_sparse_matrix_test.cc b/internal/ceres/triplet_sparse_matrix_test.cc
index e145c1a2..bde9a6ed 100644
--- a/MODULE.bazel
+++ b/MODULE.bazel
@@ -6,3 +6,4 @@
 bazel_dep(name = "googletest", version = "1.16.0")
 bazel_dep(name = "eigen", version = "3.4.0")
 bazel_dep(name = "google_benchmark", version = "1.8.4")
+bazel_dep(name = "rules_cc", version = "0.2.13")
